T123=eye(4);
flag_block = zeros(16,1);
T123_1 = [  -0.845447  -0.0486908   -0.531835      27.684
-0.00939705    0.997037   -0.076343    -13.4856
   0.533976  -0.0595463     -0.8434     328.739
          0           0           0           1];
[T123_1,flag1] = refineT(T123_1);
flag_block(1)=flag1;
T258=[ 0.0479531  -0.822284   0.567054    45.6131
 -0.996585 -0.0775911 -0.0282382   -6.84712
 0.0672181  -0.563763  -0.823197    332.157
         0          0          0          1];
[T258,flag1] = refineT(T258);
flag_block(2)=flag1;
T123_2=[ -0.035043   0.804299  -0.593191    21.0076
  0.998845 0.00866763 -0.0472548   -8.05971
-0.0328654  -0.594162  -0.803674    334.363
         0          0          0          1];
[T123_2,flag1] = refineT(T123_2);
flag_block(3)=flag1;
T789=[ 0.0207109  -0.862876   0.504991    43.7357
   -0.9995 -0.0299389 -0.0101646    -6.8402
 0.0238897  -0.504528  -0.863065     333.09
         0          0          0          1];
[T789,flag1] = refineT(T789);
flag_block(4)=flag1;
T123_3=[ -0.035043   0.804299  -0.593191    21.0076
  0.998845 0.00866763 -0.0472548   -8.05971
-0.0328654  -0.594162  -0.803674    334.363
         0          0          0          1];
[T123_3,flag1] = refineT(T123_3);
flag_block(5)=flag1;
T468=[ 0.818021 -0.509888 -0.266187   32.5157
0.0129698 -0.446313  0.894783   6.67886
-0.575041 -0.735404 -0.358481   340.882
        0         0         0         1];
[T468,flag1] = refineT(T468);
flag_block(6)=flag1;
T123_4=[0.00548014  -0.821672  -0.569935    27.8817
 -0.999558  -0.021154  0.0208865    -6.2391
-0.0292182   0.569569  -0.821424    330.852
         0          0          0          1];
[T123_4,flag1] = refineT(T123_4);
flag_block(7)=flag1;
T357=[-0.00687557   -0.847111    0.531372     42.0513
  -0.999276   0.0256982   0.0280381    -6.90732
 -0.0374067   -0.530794   -0.846675     336.884
          0           0           0           1];
[T357,flag1] = refineT(T357);
flag_block(8)=flag1;
T357_1=[ 0.0752186  -0.899349  -0.430712     28.764
 -0.995958 -0.0890257  0.0119585   -7.19405
-0.0490993   0.428071   -0.90241    344.072
         0          0          0          1];
[T357_1,flag1] = refineT(T357_1);
flag_block(9)=flag1;
T147=[-0.0902417   0.909545   0.405691    34.2069
  0.994283  0.0589372  0.0890328   -6.71195
  0.057069   0.411406  -0.909664    343.918
         0          0          0          1];
[T147,flag1] = refineT(T147);
flag_block(10)=flag1;
T468_1=[   0.132289   -0.894595   -0.426847     32.6653
  -0.989769   -0.142444 -0.00821305    -7.02791
 -0.0534546    0.423567   -0.904286     339.642
          0           0           0           1];
[T468_1,flag1] = refineT(T468_1);
flag_block(11)=flag1;
T159=[-0.0920107   0.908253   0.408179    37.8837
  0.993602  0.0567818  0.0976282   -6.50525
  0.065494    0.41455  -0.907667    339.238
         0          0          0          1];
[T159,flag1] = refineT(T159);
flag_block(12)=flag1;
T789_1=[ 0.0289121  -0.880834  -0.472541    31.0695
 -0.998922 -0.0426406  0.0183653   -7.06818
-0.0363262     0.4715  -0.881117    343.915
         0          0          0          1];
[T789_1,flag1] = refineT(T789_1);
flag_block(13)=flag1;
T456=[-0.0150962    0.929589    0.368287     36.6953
   0.998215 -0.00727405   0.0592775    -6.61654
  0.0577827    0.368525    -0.92782     343.088
          0           0           0           1];
[T456,flag1] = refineT(T456);
flag_block(14)=flag1;
T258_1=[   0.106578   -0.903542   -0.415034     28.7884
  -0.993577   -0.112739 -0.00970794    -7.10031
 -0.0380189    0.413403   -0.909754     345.864
          0           0           0           1];
[T258_1,flag1] = refineT(T258_1);
flag_block(15)=flag1;
T369=[-0.104587  0.897909  0.427577   33.9608
 0.993448 0.0744077 0.0867458  -6.50198
0.0460748  0.433848 -0.899807   345.652
        0         0         0         1];
[T369,flag1] = refineT(T369);
flag_block(16)=flag1;

Tt123=T123;
Tt258=T123_1\T258;
Tt789=T123_2\T789;
Tt468=T123_3\T468;
Tt357=T123_4\T357;
Tt369=Tt258*(T258_1\T369);
Tt456=Tt789*(T789_1\T456);
Tt159=Tt468*(T468_1\T159);
Tt147=Tt357*(T357_1\T147);

[d123789, p123789] = getCrossLine(Tt123(1:3,3),Tt123(1:3,4),...
    Tt789(1:3,3),Tt789(1:3,4),Tt789(1:3,2));
[d123258, p123258] = getCrossLine(Tt123(1:3,3),Tt123(1:3,4),...
    Tt258(1:3,3),Tt258(1:3,4),Tt258(1:3,2));
[d123468, p123468] = getCrossLine(Tt123(1:3,3),Tt123(1:3,4),...
    Tt468(1:3,3),Tt468(1:3,4),Tt468(1:3,2));
[d123357, p123357] = getCrossLine(Tt123(1:3,3),Tt123(1:3,4),...
    Tt357(1:3,3),Tt357(1:3,4),Tt357(1:3,2));

dot_size1=[dot(d123258,d123789) dot(d123789,d123468) ...
    dot(d123468,d123357) dot(d123357,d123258)];

[d468159, p468159] = getCrossLine(Tt468(1:3,3),Tt468(1:3,4),...
    Tt159(1:3,3),Tt159(1:3,4),Tt159(1:3,2));
[d357147, p357147] = getCrossLine(Tt357(1:3,3),Tt357(1:3,4),...
    Tt147(1:3,3),Tt147(1:3,4),Tt147(1:3,2));
[d258369, p258369] = getCrossLine(Tt258(1:3,3),Tt258(1:3,4),...
    Tt369(1:3,3),Tt369(1:3,4),Tt369(1:3,2));
[d789456, p789456] = getCrossLine(Tt789(1:3,3),Tt789(1:3,4),...
    Tt456(1:3,3),Tt456(1:3,4),Tt456(1:3,2));

dot_size2=[dot(d789456,d258369) dot(d258369,d357147) ...
    dot(d357147,d468159) dot(d468159,d789456)];
position60=zeros(3,60);
for i = 1:15
    position60(:,i)=p468159+(i-8)*d468159*2;
    position60(:,i+15)=p357147+(i-8)*d357147*2;
    position60(:,i+30)=p258369+(i-8)*d258369*2;
    position60(:,i+45)=p789456+(i-8)*d789456*2;
end
position60 = position60';
planes = fitPlane_SVD(position60);
p = [1 1 -(planes(1)+planes(2)+planes(4))/planes(3)];

z = planes(1:3)/norm(planes(1:3));
if(dot(z,[0 0 1])<0)
    z=-z;
end
origin = pointProjection(z,p,mean(position60));
P_proj = pointProjection(z,p,p468159');
x = (P_proj-origin)/norm(P_proj-origin);
y=cross(z,x);

T123t = [x',y',z',origin';0 0 0 1];
To = eye(4);
To123=inv(T123t);%eye(4);%
To147 = To123*Tt147;
To159 = To123*Tt159;
To258 = To123*Tt258;
To357 = To123*Tt357;
To369 = To123*Tt369;
To456 = To123*Tt456;
To468 = To123*Tt468;
To789 = To123*Tt789;
figure(1);hold on;axis equal;grid on;
PlotAxis(10,To);PlotAxis(5,To123);
PlotAxis(5,To159);PlotAxis(5,To357);PlotAxis(5,To147);PlotAxis(5,To468);
PlotAxis(5,To258);PlotAxis(5,To369);PlotAxis(5,To456);PlotAxis(5,To789);
for i = 1:60
    p0=[position60(i,:) 1]';
    p1 = To123*p0;
    position60(i,:)=p1(1:3)';
end
plot3(position60(:,1),position60(:,2),position60(:,3),'r*');

function [T,flag] = refineT(T0)
T = T0;
r1=T0(1,1:3);r2=T0(2,1:3);
r1 = r1/norm(r1);
r3 = cross(r1,r2)/norm(cross(r1,r2));
r2 = cross(r3,r1);
Rtem=[r1;r2;r3];
c1=Rtem(1:3,1);c2=Rtem(1:3,2);
c1 = c1/norm(c1);
c3 = cross(c1,c2)/norm(cross(c1,c2));
c2 = cross(c3,c1);
T(1:3,1:3)=[c1,c2,c3];
axang = rotm2axang(T(1:3,1:3)'*T0(1:3,1:3));
flag = axang(4)*180/pi;
end

function [direction, intersection_point] = getCrossLine(n1,p1,n2,p2,y2)
    % 定义平面参数
    % 定义平面1参数
    a1 = n1(1); % 平面1的法向量的x分量
    b1 = n1(2); % 平面1的法向量的y分量
    c1 = n1(3); % 平面1的法向量的z分量
    
    % 定义平面2参数
    a2 = n2(1); % 平面2的法向量的x分量
    b2 = n2(2); % 平面2的法向量的y分量
    c2 = n2(3); % 平面2的法向量的z分量


    % 计算交线
    direction = cross([a1, b1, c1]', [a2, b2, c2]');

    % 直线参数
%     V = y2; % 直线的方向向量
    
    % 平面参数
    A = a1; % 平面的法向量的y分量
    B= b1; % 平面的法向量的z分量
    C = c1; % 平面的常数项
    D = -dot(n1,p1);
    
    % 计算 t 值
    t = (-D - A*p2(1) - B*p2(2) - C*p2(3)) / (A*y2(1) + B*y2(2) + C*y2(3));
    
    % 计算交点坐标
    intersection_point = p2 + t * y2;    
%     % 输出结果
%     disp('交线的方向向量：');
%     disp(direction);
%     
%     disp('交点坐标：');
%     disp(intersection_point);
end

function planes = fitPlane_SVD(data)
% 功能：利用SVD拟合平面
% 输入：data   - 原始数据(m*3)    
% 输出：planes - 拟合所得平面参数 
points = data(:,1:3);
% 去质心
M = points - repmat(mean(points),size(points,1),1);
% 奇异值分解
[~,~,V] = svd(M,0);
% 最小特征值对应的特征向量为法向量
normal = V(:,3)';
% 平面参数标准化
dtmp = mean(points*normal');
planes(1:3) = normal'*sign(dtmp);
planes(4) = -dtmp*sign(dtmp);
end

function P_proj = pointProjection(n,p,P)
% 点到平面的投影
% 点的坐标

% 平面的法向量

% 平面上一点的坐标

% 计算点到平面的距离
d = dot(n, (P - p));

% 计算投影点的坐标
P_proj = P - d * n;
end